name: Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: project

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget python3-dev python3-pip \
            python3-setuptools python3-tk python3-wheel xz-utils \
            file make gcc gcc-multilib g++-multilib libsdl2-dev \
            libmagic1

      - name: Install West
        run: pip3 install west

      - name: Initialize West Workspace
        working-directory: project
        run: |
          west init -l .
          west update --narrow -o=--depth=1

      - name: Install Python Requirements
        working-directory: project
        run: pip3 install -r ../zephyr/scripts/requirements.txt

      - name: Download and Setup Zephyr SDK
        run: |
          cd "$HOME"
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t all -h -c

      - name: Run Unit Tests
        working-directory: project
        run: |
          west twister -T tests/unit/ch375 -p native_sim --inline-logs

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: project/twister-out/
          retention-days: 30

      - name: Check Test Results
        if: always()
        working-directory: project
        run: |
          if [ -f twister-out/twister.json ]; then
            python3 << 'EOF'
          import json
          import sys
          
          with open('twister-out/twister.json', 'r') as f:
              data = json.load(f)
          
          total = sum(len(suite['testcases']) for suite in data.get('testsuites', []))
          passed = sum(1 for suite in data.get('testsuites', []) 
                      for tc in suite['testcases'] if tc.get('status') == 'passed')
          failed = total - passed
          
          print(f"Total: {total}, Passed: {passed}, Failed: {failed}")
          
          if failed > 0:
              sys.exit(1)
          EOF
          else
            echo "No test results found"
            exit 1
          fi